{% comment %}
  AI Image Generator Section
  This section can be added to any Shopify theme
{% endcomment %}

{{ 'ai-image-generator.css' | asset_url | stylesheet_tag }}

<div class="ai-image-generator-section" id="ai-image-generator-{{ section.id }}">
  <div class="page-width">
    {% if section.settings.title != blank %}
      <h2 class="section-title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% if section.settings.description != blank %}
      <p class="section-description">{{ section.settings.description }}</p>
    {% endif %}

    <div class="ai-generator-container">
      <div class="generator-tabs">
        <button class="tab-button active" data-tab="upload">
          Upload Image
        </button>
        {% if section.settings.enable_ai_generation %}
          <button class="tab-button" data-tab="generate">
            Generate with AI
          </button>
        {% endif %}
      </div>

      <div class="tab-content active" id="upload-tab">
        <div class="upload-area" id="upload-area-{{ section.id }}">
          <input 
            type="file" 
            id="image-upload-{{ section.id }}" 
            accept="image/*" 
            class="hidden"
          />
          <label for="image-upload-{{ section.id }}" class="upload-label">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Click to upload or drag and drop</span>
            <span class="upload-hint">PNG, JPG, GIF up to 10MB</span>
          </label>
        </div>
        <div class="preview-container hidden" id="preview-{{ section.id }}">
          <img id="preview-image-{{ section.id }}" alt="Preview" />
          <button class="remove-image" id="remove-{{ section.id }}">Remove</button>
        </div>
      </div>

      {% if section.settings.enable_ai_generation %}
        <div class="tab-content" id="generate-tab">
          <div class="ai-prompt-container">
            <label for="ai-prompt-{{ section.id }}">Describe the image you want to generate:</label>
            <textarea 
              id="ai-prompt-{{ section.id }}" 
              placeholder="e.g., A beautiful sunset over mountains with vibrant colors, artistic style"
              rows="4"
            ></textarea>
            
            <div class="prompt-options">
              <div class="option-group">
                <label for="style-{{ section.id }}">Style (optional):</label>
                <select id="style-{{ section.id }}" class="style-select">
                  <option value="">Default</option>
                  <option value="realistic">Realistic</option>
                  <option value="artistic">Artistic</option>
                  <option value="abstract">Abstract</option>
                  <option value="vibrant">Vibrant</option>
                  <option value="minimalist">Minimalist</option>
                  <option value="3d render">3D Render</option>
                </select>
              </div>
              
              <div class="option-group">
                <label for="negative-prompt-{{ section.id }}">Avoid (optional):</label>
                <input 
                  type="text" 
                  id="negative-prompt-{{ section.id }}" 
                  placeholder="e.g., blurry, low quality"
                  class="negative-input"
                />
              </div>
            </div>
            
            <button class="generate-button" id="generate-btn-{{ section.id }}">
              <span class="button-text">Generate Image</span>
              <span class="button-loader hidden">Generating...</span>
            </button>
            <div class="loading-indicator hidden" id="loading-{{ section.id }}">
              <div class="spinner"></div>
              <p>Creating your image with AI...</p>
            </div>
          </div>
          <div class="generated-preview hidden" id="generated-preview-{{ section.id }}">
            <img id="generated-image-{{ section.id }}" alt="Generated" />
            <div class="preview-actions">
              <button class="use-image-button" id="use-generated-{{ section.id }}">Use This Image</button>
              <button class="regenerate-button" id="regenerate-{{ section.id }}">Regenerate</button>
            </div>
          </div>
        </div>
      {% endif %}

      <div class="action-buttons">
        <button class="primary-button" id="add-to-cart-{{ section.id }}" disabled>
          Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const shop = '{{ shop.permanent_domain }}';
  const appUrl = '{{ settings.app_url | default: "https://shopify-product-customizer.vercel.app" }}';
  
  // Tab switching
  document.querySelectorAll(`[data-tab]`).forEach(button => {
    button.addEventListener('click', function() {
      const tab = this.dataset.tab;
      
      // Update buttons
      document.querySelectorAll(`.tab-button`).forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // Update content
      document.querySelectorAll(`.tab-content`).forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tab}-tab`).classList.add('active');
    });
  });

  // Image upload handler
  const uploadInput = document.getElementById(`image-upload-${sectionId}`);
  const uploadArea = document.getElementById(`upload-area-${sectionId}`);
  const previewContainer = document.getElementById(`preview-${sectionId}`);
  const previewImage = document.getElementById(`preview-image-${sectionId}`);
  const removeBtn = document.getElementById(`remove-${sectionId}`);
  const addToCartBtn = document.getElementById(`add-to-cart-${sectionId}`);

  uploadInput?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = function() {
        previewImage.src = reader.result;
        uploadArea.classList.add('hidden');
        previewContainer.classList.remove('hidden');
        addToCartBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }
  });

  removeBtn?.addEventListener('click', function() {
    uploadInput.value = '';
    uploadArea.classList.remove('hidden');
    previewContainer.classList.add('hidden');
    addToCartBtn.disabled = true;
  });

  // AI Generation handler
  {% if section.settings.enable_ai_generation %}
  const generateBtn = document.getElementById(`generate-btn-${sectionId}`);
  const promptInput = document.getElementById(`ai-prompt-${sectionId}`);
  const loadingIndicator = document.getElementById(`loading-${sectionId}`);
  const generatedPreview = document.getElementById(`generated-preview-${sectionId}`);
  const generatedImage = document.getElementById(`generated-image-${sectionId}`);
  const useGeneratedBtn = document.getElementById(`use-generated-${sectionId}`);

  generateBtn?.addEventListener('click', async function() {
    const prompt = promptInput.value.trim();
    if (!prompt) {
      alert('Please enter a description');
      return;
    }

    const style = document.getElementById(`style-${sectionId}`)?.value || '';
    const negativePrompt = document.getElementById(`negative-prompt-${sectionId}`)?.value || '';

    generateBtn.disabled = true;
    generateBtn.querySelector('.button-text')?.classList.add('hidden');
    generateBtn.querySelector('.button-loader')?.classList.remove('hidden');
    loadingIndicator.classList.remove('hidden');
    generatedPreview.classList.add('hidden');

    try {
      const response = await fetch(`${appUrl}/api/generate-image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          shop: shop,
          prompt: prompt,
          style: style,
          negativePrompt: negativePrompt
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || errorData.details || 'Failed to generate image');
      }

      const data = await response.json();
      generatedImage.src = data.imageUrl;
      generatedPreview.classList.remove('hidden');
      addToCartBtn.disabled = false;
    } catch (error) {
      alert('Error generating image: ' + error.message);
    } finally {
      generateBtn.disabled = false;
      generateBtn.querySelector('.button-text')?.classList.remove('hidden');
      generateBtn.querySelector('.button-loader')?.classList.add('hidden');
      loadingIndicator.classList.add('hidden');
    }
  });

  // Regenerate button
  const regenerateBtn = document.getElementById(`regenerate-${sectionId}`);
  regenerateBtn?.addEventListener('click', function() {
    generateBtn?.click();
  });

  useGeneratedBtn?.addEventListener('click', function() {
    // Switch to upload tab and set the generated image
    document.querySelector(`[data-tab="upload"]`).click();
    previewImage.src = generatedImage.src;
    uploadArea.classList.add('hidden');
    previewContainer.classList.remove('hidden');
  });
  {% endif %}

  // Add to cart handler
  addToCartBtn?.addEventListener('click', async function() {
    const imageSrc = previewImage.src;
    if (!imageSrc) return;

    // Convert to base64 if needed
    const imageData = imageSrc.startsWith('data:') 
      ? imageSrc 
      : await fetch(imageSrc).then(r => r.blob()).then(blob => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        });

    // Redirect to customization page or add to cart
    const productId = new URLSearchParams(window.location.search).get('product_id');
    if (productId) {
      window.location.href = `${appUrl}/apps/customize?shop=${shop}&productId=${productId}&image=${encodeURIComponent(imageData)}`;
    } else {
      alert('Please select a product first');
    }
  });
})();
</script>

<style>
.ai-image-generator-section {
  padding: 4rem 0;
}

.section-title {
  text-align: center;
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.section-description {
  text-align: center;
  color: #666;
  margin-bottom: 2rem;
}

.generator-tabs {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 2rem;
}

.tab-button {
  padding: 0.75rem 1.5rem;
  border: 2px solid #ddd;
  background: white;
  cursor: pointer;
  border-radius: 0.5rem;
  transition: all 0.3s;
}

.tab-button.active {
  background: #4f46e5;
  color: white;
  border-color: #4f46e5;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.upload-area {
  border: 2px dashed #ddd;
  border-radius: 0.5rem;
  padding: 3rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.upload-area:hover {
  border-color: #4f46e5;
  background: #f5f5f5;
}

.upload-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  cursor: pointer;
}

.upload-hint {
  font-size: 0.875rem;
  color: #666;
}

.hidden {
  display: none !important;
}

.preview-container {
  text-align: center;
  margin: 2rem 0;
}

.preview-container img {
  max-width: 100%;
  max-height: 500px;
  border-radius: 0.5rem;
}

.remove-image {
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

.ai-prompt-container {
  max-width: 700px;
  margin: 0 auto;
}

.ai-prompt-container label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #333;
}

.ai-prompt-container textarea {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #ddd;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
  font-family: inherit;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.ai-prompt-container textarea:focus {
  outline: none;
  border-color: #8b5cf6;
}

.prompt-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.option-group {
  display: flex;
  flex-direction: column;
}

.option-group label {
  font-size: 0.875rem;
  margin-bottom: 0.25rem;
  color: #666;
}

.style-select,
.negative-input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  font-family: inherit;
}

.style-select:focus,
.negative-input:focus {
  outline: none;
  border-color: #8b5cf6;
}

.generate-button {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 1.125rem;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
}

.generate-button:hover:not(:disabled) {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
  transform: translateY(-2px);
}

.generate-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.button-loader {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.loading-indicator {
  text-align: center;
  padding: 2rem;
  color: #666;
}

.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #8b5cf6;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.generated-preview {
  margin-top: 2rem;
  text-align: center;
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.generated-preview img {
  max-width: 100%;
  max-height: 600px;
  border-radius: 0.75rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  border: 2px solid #e5e7eb;
}

.preview-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

.use-image-button,
.regenerate-button {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.use-image-button {
  background: #10b981;
  color: white;
}

.use-image-button:hover {
  background: #059669;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.regenerate-button {
  background: #6366f1;
  color: white;
}

.regenerate-button:hover {
  background: #4f46e5;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
}

.action-buttons {
  margin-top: 2rem;
  text-align: center;
}

.primary-button {
  padding: 1rem 2rem;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-size: 1.125rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}

.primary-button:hover:not(:disabled) {
  background: #059669;
}

.primary-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

