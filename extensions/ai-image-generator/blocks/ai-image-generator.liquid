{% comment %}
  AI Image Generator Section
  This section can be added to any Shopify theme
{% endcomment %}

{{ 'ai-image-generator.css' | asset_url | stylesheet_tag }}

<div class="ai-image-generator-section" id="ai-image-generator-{{ section.id }}">
  <div class="page-width">
    {% if section.settings.title != blank %}
      <h2 class="section-title">{{ section.settings.title }}</h2>
    {% endif %}
    
    {% if section.settings.description != blank %}
      <p class="section-description">{{ section.settings.description }}</p>
    {% endif %}

    <div class="ai-generator-container">
      <div class="generator-tabs">
        <button class="tab-button active" data-tab="upload">
          Upload Image
        </button>
        {% if section.settings.enable_ai_generation %}
          <button class="tab-button" data-tab="generate">
            Generate with AI
          </button>
        {% endif %}
      </div>

      <div class="tab-content active" id="upload-tab">
        <div class="upload-area" id="upload-area-{{ section.id }}">
          <input 
            type="file" 
            id="image-upload-{{ section.id }}" 
            accept="image/*" 
            class="hidden"
          />
          <label for="image-upload-{{ section.id }}" class="upload-label">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Click to upload or drag and drop</span>
            <span class="upload-hint">PNG, JPG, GIF up to 10MB</span>
          </label>
        </div>
        <div class="preview-container hidden" id="preview-{{ section.id }}">
          <img id="preview-image-{{ section.id }}" alt="Preview" />
          <button class="remove-image" id="remove-{{ section.id }}">Remove</button>
        </div>
      </div>

      {% if section.settings.enable_ai_generation %}
        <div class="tab-content" id="generate-tab">
          <div class="ai-prompt-container">
            <label for="ai-prompt-{{ section.id }}">Describe the image you want to generate:</label>
            <textarea 
              id="ai-prompt-{{ section.id }}" 
              placeholder="e.g., A beautiful sunset over mountains with vibrant colors"
              rows="4"
            ></textarea>
            <button class="generate-button" id="generate-btn-{{ section.id }}">
              Generate Image
            </button>
            <div class="loading-indicator hidden" id="loading-{{ section.id }}">
              Generating your image...
            </div>
          </div>
          <div class="generated-preview hidden" id="generated-preview-{{ section.id }}">
            <img id="generated-image-{{ section.id }}" alt="Generated" />
            <button class="use-image-button" id="use-generated-{{ section.id }}">Use This Image</button>
          </div>
        </div>
      {% endif %}

      <div class="action-buttons">
        <button class="primary-button" id="add-to-cart-{{ section.id }}" disabled>
          Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const shop = '{{ shop.permanent_domain }}';
  const appUrl = '{{ settings.app_url | default: "https://shopify-product-customizer.vercel.app" }}';
  
  // Tab switching
  document.querySelectorAll(`[data-tab]`).forEach(button => {
    button.addEventListener('click', function() {
      const tab = this.dataset.tab;
      
      // Update buttons
      document.querySelectorAll(`.tab-button`).forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // Update content
      document.querySelectorAll(`.tab-content`).forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tab}-tab`).classList.add('active');
    });
  });

  // Image upload handler
  const uploadInput = document.getElementById(`image-upload-${sectionId}`);
  const uploadArea = document.getElementById(`upload-area-${sectionId}`);
  const previewContainer = document.getElementById(`preview-${sectionId}`);
  const previewImage = document.getElementById(`preview-image-${sectionId}`);
  const removeBtn = document.getElementById(`remove-${sectionId}`);
  const addToCartBtn = document.getElementById(`add-to-cart-${sectionId}`);

  uploadInput?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = function() {
        previewImage.src = reader.result;
        uploadArea.classList.add('hidden');
        previewContainer.classList.remove('hidden');
        addToCartBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }
  });

  removeBtn?.addEventListener('click', function() {
    uploadInput.value = '';
    uploadArea.classList.remove('hidden');
    previewContainer.classList.add('hidden');
    addToCartBtn.disabled = true;
  });

  // AI Generation handler
  {% if section.settings.enable_ai_generation %}
  const generateBtn = document.getElementById(`generate-btn-${sectionId}`);
  const promptInput = document.getElementById(`ai-prompt-${sectionId}`);
  const loadingIndicator = document.getElementById(`loading-${sectionId}`);
  const generatedPreview = document.getElementById(`generated-preview-${sectionId}`);
  const generatedImage = document.getElementById(`generated-image-${sectionId}`);
  const useGeneratedBtn = document.getElementById(`use-generated-${sectionId}`);

  generateBtn?.addEventListener('click', async function() {
    const prompt = promptInput.value.trim();
    if (!prompt) {
      alert('Please enter a description');
      return;
    }

    generateBtn.disabled = true;
    loadingIndicator.classList.remove('hidden');

    try {
      const response = await fetch(`${appUrl}/api/generate-image`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          shop: shop,
          prompt: prompt
        })
      });

      if (!response.ok) {
        throw new Error('Failed to generate image');
      }

      const data = await response.json();
      generatedImage.src = data.imageUrl;
      generatedPreview.classList.remove('hidden');
      addToCartBtn.disabled = false;
    } catch (error) {
      alert('Error generating image: ' + error.message);
    } finally {
      generateBtn.disabled = false;
      loadingIndicator.classList.add('hidden');
    }
  });

  useGeneratedBtn?.addEventListener('click', function() {
    // Switch to upload tab and set the generated image
    document.querySelector(`[data-tab="upload"]`).click();
    previewImage.src = generatedImage.src;
    uploadArea.classList.add('hidden');
    previewContainer.classList.remove('hidden');
  });
  {% endif %}

  // Add to cart handler
  addToCartBtn?.addEventListener('click', async function() {
    const imageSrc = previewImage.src;
    if (!imageSrc) return;

    // Convert to base64 if needed
    const imageData = imageSrc.startsWith('data:') 
      ? imageSrc 
      : await fetch(imageSrc).then(r => r.blob()).then(blob => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
        });

    // Redirect to customization page or add to cart
    const productId = new URLSearchParams(window.location.search).get('product_id');
    if (productId) {
      window.location.href = `${appUrl}/apps/customize?shop=${shop}&productId=${productId}&image=${encodeURIComponent(imageData)}`;
    } else {
      alert('Please select a product first');
    }
  });
})();
</script>

<style>
.ai-image-generator-section {
  padding: 4rem 0;
}

.section-title {
  text-align: center;
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.section-description {
  text-align: center;
  color: #666;
  margin-bottom: 2rem;
}

.generator-tabs {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-bottom: 2rem;
}

.tab-button {
  padding: 0.75rem 1.5rem;
  border: 2px solid #ddd;
  background: white;
  cursor: pointer;
  border-radius: 0.5rem;
  transition: all 0.3s;
}

.tab-button.active {
  background: #4f46e5;
  color: white;
  border-color: #4f46e5;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.upload-area {
  border: 2px dashed #ddd;
  border-radius: 0.5rem;
  padding: 3rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.upload-area:hover {
  border-color: #4f46e5;
  background: #f5f5f5;
}

.upload-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  cursor: pointer;
}

.upload-hint {
  font-size: 0.875rem;
  color: #666;
}

.hidden {
  display: none !important;
}

.preview-container {
  text-align: center;
  margin: 2rem 0;
}

.preview-container img {
  max-width: 100%;
  max-height: 500px;
  border-radius: 0.5rem;
}

.remove-image {
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

.ai-prompt-container {
  max-width: 600px;
  margin: 0 auto;
}

.ai-prompt-container label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.ai-prompt-container textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  margin-bottom: 1rem;
  font-family: inherit;
}

.generate-button {
  width: 100%;
  padding: 0.75rem;
  background: #8b5cf6;
  color: white;
  border: none;
  border-radius: 0.25rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}

.generate-button:hover:not(:disabled) {
  background: #7c3aed;
}

.generate-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.loading-indicator {
  text-align: center;
  padding: 1rem;
  color: #666;
}

.generated-preview {
  margin-top: 2rem;
  text-align: center;
}

.generated-preview img {
  max-width: 100%;
  max-height: 500px;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.use-image-button {
  padding: 0.75rem 1.5rem;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

.action-buttons {
  margin-top: 2rem;
  text-align: center;
}

.primary-button {
  padding: 1rem 2rem;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-size: 1.125rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}

.primary-button:hover:not(:disabled) {
  background: #059669;
}

.primary-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

